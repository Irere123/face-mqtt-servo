<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.R.A. System Dashboard</title>
    <!-- Use Google Fonts for premium look -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0a0a12;
            --panel-bg: #13131f;
            --accent-color: #00d4ff;
            /* Neon Blue */
            --alert-color: #ff0055;
            /* Neon Red */
            --success-color: #00ff9d;
            /* Neon Green */
            --text-color: #e0e0e0;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 40px 0 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        /* Ambient Background */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 15% 0%, rgba(0, 212, 255, 0.09), transparent 55%),
                radial-gradient(circle at 85% 100%, rgba(255, 0, 85, 0.12), transparent 55%),
                radial-gradient(circle at 50% 40%, rgba(0, 255, 157, 0.05), transparent 60%);
            opacity: 0.9;
            pointer-events: none;
            z-index: -1;
        }

        header {
            width: 100%;
            padding: 16px 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(to bottom, rgba(19, 19, 31, 0.95), rgba(19, 19, 31, 0.85));
            backdrop-filter: blur(14px);
            position: fixed;
            top: 0;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 22px;
            width: 90%;
            max-width: 1200px;
            margin-top: 96px;
            margin-bottom: 16px;
        }

        .card {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }

        .value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        #movement-status {
            color: var(--success-color);
        }

        #timestamp {
            font-size: 1.5rem;
            color: #888;
        }

        #connection-status {
            font-size: 1.2rem;
            color: #888;
        }

        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .connected {
            background: rgba(0, 255, 157, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .disconnected {
            background: rgba(255, 0, 85, 0.1);
            color: var(--alert-color);
            border: 1px solid var(--alert-color);
        }

        /* Animation for movement */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(0, 212, 255, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0);
            }
        }

        .active-update {
            animation: pulse 0.5s ease-out;
        }

        #log-panel {
            grid-column: 1 / -1;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            color: #aaa;
        }

        .log-entry {
            margin: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>

    <header>
        <h1>S.A.R.A. Vision Control</h1>
        <div style="margin-top: 5px; font-size: 0.8rem; color: #666;">Distributed Actuation System â€¢ Team 313</div>
    </header>

    <div class="container">
        <!-- Face Picture Card -->
        <div class="card">
            <h2>Face Picture</h2>
            <div id="face-container"
                style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                <img id="face-image" src="" alt="No face detected"
                    style="max-width: 100%; max-height: 300px; border-radius: 8px; display: none; border: 2px solid var(--accent-color);" />
                <div id="no-face-msg" style="color: #666; font-size: 1rem;">Waiting for face...</div>
            </div>
        </div>

        <!-- Movement Status Card -->
        <div class="card">
            <h2>Tracking Status</h2>
            <div id="movement-status" class="value">WAITING...</div>
            <div id="target-info" style="font-size: 1.2rem; color: #aaa; margin-top: 10px;">Target: --</div>
            <div id="lock-status" class="status-badge" style="background: #333; color: #888; margin-top: 5px;">SEARCHING
            </div>
            <div id="confidence" style="font-size: 0.9rem; color: #666; margin-top: 5px;">Confidence: --</div>
        </div>

        <!-- System State Card -->
        <div class="card">
            <h2>System Connection</h2>
            <div id="connection-status" class="status-badge disconnected">Disconnected</div>
            <div id="timestamp" class="value" style="margin-top: 20px;">--:--:--</div>
        </div>

        <!-- Log Panel -->
        <div class="card" id="log-panel">
            <h2>Event Log</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Connect to Backend running on PC
        const wsUrl = `ws://10.12.75.96:9002`;
        let ws;

        const statusEl = document.getElementById('movement-status');
        const connEl = document.getElementById('connection-status');
        const timeEl = document.getElementById('timestamp');
        const confEl = document.getElementById('confidence');
        const logsEl = document.getElementById('logs');

        function connect() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Connected to Backend');
                connEl.textContent = 'CONNECTED';
                connEl.className = 'status-badge connected';
                addLog('System connected to backend.');
            };

            ws.onclose = () => {
                console.log('Disconnected');
                connEl.textContent = 'DISCONNECTED';
                connEl.className = 'status-badge disconnected';
                addLog('Connection lost. Reconnecting...');
                setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Handle STATUS messages
                    if (data.type === 'STATUS') {
                        addLog(data.message);
                        return;
                    }

                    // Handle MQTT Movement messages
                    // Expected: { "status": "MOVE_LEFT", "confidence": 0.9, "timestamp": ... }
                    if (data.status) {
                        updateDashboard(data);
                    }
                } catch (e) {
                    console.log('Non-JSON message:', event.data);
                }
            };
        }

        const targetEl = document.getElementById('target-info');
        const lockEl = document.getElementById('lock-status');
        const faceImageEl = document.getElementById('face-image');
        const noFaceMsgEl = document.getElementById('no-face-msg');

        function updateDashboard(data) {
            statusEl.textContent = data.status;

            // Update Target Info
            if (data.target) targetEl.textContent = `Target: ${data.target}`;

            // Update Face Image - only update if new image received
            if (data.face_image) {
                faceImageEl.src = 'data:image/jpeg;base64,' + data.face_image;
                faceImageEl.style.display = 'block';
                noFaceMsgEl.style.display = 'none';
            }
            // Only clear image when target is lost (not locked)
            else if (!data.locked) {
                faceImageEl.style.display = 'none';
                noFaceMsgEl.style.display = 'block';
            }
            // If locked but no new image, keep showing existing image

            // Update Lock Status
            if (data.locked) {
                lockEl.textContent = "LOCKED";
                lockEl.style.background = "rgba(0, 255, 157, 0.2)";
                lockEl.style.color = "#00ff9d";
                lockEl.style.border = "1px solid #00ff9d";
            } else {
                lockEl.textContent = "SEARCHING";
                lockEl.style.background = "rgba(255, 165, 0, 0.2)";
                lockEl.style.color = "orange";
                lockEl.style.border = "1px solid orange";
            }

            // Visual feedback based on status
            if (data.status === 'MOVE_LEFT') {
                statusEl.style.color = '#ff0055'; // Red
            } else if (data.status === 'MOVE_RIGHT') {
                statusEl.style.color = '#00d4ff'; // Blue
            } else if (data.status === 'CENTERED') {
                statusEl.style.color = '#00ff9d'; // Green
            } else {
                statusEl.style.color = '#888';
            }

            statusEl.parentElement.classList.remove('active-update');
            void statusEl.parentElement.offsetWidth; // Trigger reflow
            statusEl.parentElement.classList.add('active-update');

            if (data.confidence) confEl.textContent = `Confidence: ${(data.confidence * 100).toFixed(1)}%`;

            const date = new Date();
            timeEl.textContent = date.toLocaleTimeString();
        }

        function addLog(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsEl.insertBefore(entry, logsEl.firstChild);
        }

        // Init
        connect();
    </script>
</body>

</html>